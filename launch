#!/bin/bash
# Praxis Launch Script - Simple router for Praxis commands

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if we're already in a virtual environment or if .venv exists
# Only activate if .venv exists and we're not already in a venv
if [ -z "$VIRTUAL_ENV" ] && [ -d "$SCRIPT_DIR/.venv" ]; then
    # Activate the virtual environment
    . "$SCRIPT_DIR/.venv/bin/activate"
elif [ -z "$VIRTUAL_ENV" ] && [ ! -d "$SCRIPT_DIR/.venv" ]; then
    # Create and activate virtual environment if it doesn't exist
    echo "Creating virtual environment..."
    python3 -m venv "$SCRIPT_DIR/.venv"
    . "$SCRIPT_DIR/.venv/bin/activate"
fi

# Check if any arguments were provided
if [ $# -eq 0 ]; then
    # No arguments - run the default training script
    exec python "$SCRIPT_DIR/main.py"
fi

# Parse the first argument as the command
COMMAND="$1"
shift  # Remove the first argument

# Route based on command
case "$COMMAND" in
    tokenizer|tokenizers|train-tokenizer)
        # Tokenizer training
        exec python -m praxis.tokenizers.train "$@"
        ;;
    
    archivist|archive)
        # Archivist tool
        exec python "$SCRIPT_DIR/archivist.py" "$@"
        ;;
    
    run|train)
        # Explicit training command
        exec python "$SCRIPT_DIR/main.py" "$@"
        ;;
    
    --help|-h|help)
        # First show main.py help
        python "$SCRIPT_DIR/main.py" --help
        
        # Then append launcher-specific commands
        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        echo "launcher commands:"
        echo "  tokenizer               Train or manage tokenizers"
        echo "  archivist               Run the archivist tool"
        echo ""
        echo "launcher examples:"
        echo "  ./launch tokenizer --help   # Show tokenizer options"
        echo "  ./launch archivist --help   # Show archivist options"
        ;;
    
    *)
        # Unknown command - pass all args to main.py
        # This allows "./launch --dev" to work
        exec python "$SCRIPT_DIR/main.py" "$COMMAND" "$@"
        ;;
esac